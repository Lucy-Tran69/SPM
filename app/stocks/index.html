<?php
    include_once "html/header.inc";
    include_once "html/menu.inc";
    if (isset($_SESSION["loginAccount"])) {
?>
<style>
    .hidden {
        display: none;
    }

    #topicsList a {
        text-decoration: underline;
    }
</style>
<div class="card">
    <!-- /.card-header -->
    <div id="topicTable" class="card-body table-responsive p-0" style="height: 350px;">
        <table class="table table-striped table-head-fixed text-nowrap">
            <thead>
                <tr>
                    <th style="width: 120px;">Date</th>
                    <th>Title</th>
                </tr>
            </thead>
            <tbody id="topicsList">
                <?php include 'topicsList.php'; ?>
            </tbody>
        </table>
        <div id="loadding" class="hidden text-center">
            Loadding ...
        </div>
        <button id="loadmore" type="button" class="btn btn-block btn-primary"
            style="width: 100px; margin: 10px auto;">Load
            More</button>
    </div>
    <!-- /.card-body -->
</div>
<div class="modal fade bd-example-modal-lg" id="modal-detail-topic">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title"></h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="container-fluid">
                    <div class="row justify-content-end" style="margin-bottom: 10px;">
                        <span id="openday"></span>
                    </div>
                    <div class="row mb-2 justify-content-center" id="img" style="margin-bottom: 10px;">
                        <a href="#" target="_blank" rel="noopener noreferrer" id="imgLink">
                            <img id="topicImage" style="width: 250px;" />
                        </a>
                    </div>
                    <div class="row" style="margin-bottom: 10px;">
                        <p id="topicBody"></p>
                    </div>
                    <div class="row">
                        <p><a id="topicLink" target="_blank" href="#"></a></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-default" data-dismiss="modal">閉じる</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->
<?php
} else {
  //header("Location: ../../include/logout.php");
}
include_once "html/foot.inc" ?>
<script>
    // Biến dùng kiểm tra nếu đang gửi ajax thì ko thực hiện gửi thêm
    var is_busy = false;

    // Biến lưu trữ trang hiện tại
    var page = 1;

    // Biến lưu trữ rạng thái phân trang 
    var stopped = false;

    $(document).ready(function () {
        // Khi kéo scroll thì xử lý
        $topicTable = $('#topicTable');

        // $($topicTable).scroll(function () {
        // Element append nội dung
        $element = $('#topicsList');
        // ELement hiển thị chữ loadding
        $loadding = $('#loadding');

        // Nếu màn hình đang ở dưới cuối thẻ thì thực hiện ajax
        $('#loadmore').click(function () {
            // Nếu đang gửi ajax thì ngưng
            if (is_busy == true) {
                return false;
            }

            // Nếu hết dữ liệu thì ngưng
            if (stopped == true) {
                return false;
            }

            // Thiết lập đang gửi ajax
            is_busy = true;

            // Tăng số trang lên 1
            page++;

            // Hiển thị loadding
            $loadding.removeClass('hidden');

            // Gửi Ajax
            $.ajax(
                {
                    type: 'get',
                    dataType: 'text',
                    url: 'topicsList.php',
                    data: { page: page },
                    success: function (result) {
                        $element.append(result);
                    }
                })
                .always(function () {
                    // Sau khi thực hiện xong ajax thì ẩn hidden và cho trạng thái gửi ajax = false
                    $loadding.addClass('hidden');
                    is_busy = false;
                });
            return false;
        });
        // });

        $('.item-topic').click(function () {
            var id = $(this).data("id");
            $.ajax(
                {
                    type: 'post',
                    dataType: 'json',
                    url: 'topicDetail.php',
                    data: { id: id },
                    success: function (result) {
                        let link_title = result['link_title'];
                        let link_url = result['link_url'];
                        let image_link = result['image_link'];
                        let topicImage = result['image'];

                        $('.modal-title').text(result['title']);
                        $('#openday').text(result['open_day']);
                        $('#imgLink').attr("href", image_link);
                        if (!$.trim(topicImage) == '') {
                            $('#topicImage').attr("src", "../../app/refer/images/topics/" + topicImage);
                        }
                        $('#topicBody').text(result['body']);
                        $('#topicLink').attr("href", link_url);
                        $('#topicLink').text(link_url);
                        if (!$.trim(link_title) == '') {
                            $('#topicLink').text(link_title);
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        console.log('AJAX call failed.');
                        console.log(textStatus + ': ' + errorThrown);
                    }
                });
        });
    });
</script>
</body>

</html>